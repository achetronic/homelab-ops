---
# yaml-language-server: $schema=https://json.schemastore.org/helmfile

bases:
  - base.yaml

releases:
  # ATTENTION: This is a special release to create namespaces.
  # It's not possible to set release namespaces as this would try to change all the Namespace
  # resources existing in the release to defined one, causing conflicts.
  # I will look for a better solution in the future to this issue
  - name: special-namespaces
    chart: ../applications/00-special-namespaces
    installed: true

  - name: metrics-server
    namespace: metrics-server
    createNamespace: true
    chart: ../applications/metrics-server
    values:
      - ../applications/metrics-server/values-kubernetes-01.yaml
    installed: true

  ###########################################################
  ## CERT MANAGER COMPONENTS
  ###########################################################
  - name: cert-manager
    namespace: cert-manager
    createNamespace: true
    chart: ../applications/cert-manager/operator
    values:
      - ../applications/cert-manager/operator/values-global.yaml
    installed: true

  - name: cert-manager-extra
    namespace: cert-manager
    chart: ../applications/cert-manager/extra/dns-01
    needs:
      - cert-manager/cert-manager
    installed: true

  ###########################################################
  ## CSI DRIVERS
  ###########################################################
  - name: csi-driver-nfs
    namespace: csi-driver-nfs
    chart: ../applications/csi-driver-nfs/operator
    values:
      - ../applications/csi-driver-nfs/operator/values-global.yaml
    installed: true

  - name: csi-driver-nfs-extra
    namespace: csi-driver-nfs
    chart: ../applications/csi-driver-nfs/extra
    needs:
      - csi-driver-nfs/csi-driver-nfs
    installed: true

  - name: csi-driver-s3
    namespace: csi-driver-s3
    chart: ../applications/csi-driver-s3/operator
    values:
      - ../applications/csi-driver-s3/operator/values-global.yaml
    needs:
    installed: true

  - name: csi-driver-s3-extra
    namespace: csi-driver-s3
    chart: ../applications/csi-driver-s3/extra
    needs:
      - csi-driver-s3/csi-driver-s3
    installed: true

  - name: ddns-updater
    namespace: ddns-updater
    createNamespace: true
    chart: ../applications/ddns-updater/kubernetes-01
    needs:
      - external-secrets/external-secrets-extra
    installed: true

  ###########################################################
  ## EXTERNAL SECRETS
  ###########################################################
  - name: external-secrets
    namespace: external-secrets
    createNamespace: true
    chart: ../applications/external-secrets/operator
    installed: true

  - name: external-secrets-extra
    namespace: external-secrets
    chart: ../applications/external-secrets/extra
    needs:
      - external-secrets/external-secrets
    installed: true

  - name: ingress-nginx
    namespace: ingress-nginx
    createNamespace: true
    chart: ../applications/ingress-nginx
    values:
      - ../applications/ingress-nginx/values-global.yaml
      - ../applications/ingress-nginx/values-kubernetes-01.yaml
    needs:
      - metallb/metallb-extra
    installed: false

  ###########################################################
  ## ISTIO COMPONENTS
  ###########################################################
  - name: istio-base
    namespace: istio
    chart: istio/base
    version: &istioVersionRef 1.26.2
    values:
      - ../applications/istio/base.yaml
    installed: true

  - name: istio-discovery
    namespace: istio
    chart: istio/istiod
    version: *istioVersionRef
    values:
      - ../applications/istio/discovery.yaml
    installed: true

  - name: istio-gateway-production
    namespace: istio
    chart: istio/gateway
    version: *istioVersionRef
    values:
      - ../applications/istio/gateway.yaml
    installed: true

  - name: gateway-api
    namespace: istio
    chart: ../applications/gateway-api/crds/v1.3.0
    disableValidation: true
    installed: true

  - name: gateway-api-extra
    needs:
      - istio/gateway-api
    namespace: istio
    chart: bjw-s/app-template
    version: 4.2.0
    values:
      - ../applications/gateway-api/extra/certificates.yaml
      - ../applications/gateway-api/extra/gateway.yaml
    installed: true
    disableValidation: true

  ###########################################################
  ## METALLB COMPONENTS
  ###########################################################
  - name: metallb
    namespace: metallb
    chart: ../applications/metallb/operator
    values:
      - ../applications/metallb/operator/values-global.yaml
    installed: true

  - name: metallb-extra
    namespace: metallb
    chart: ../applications/metallb/extra/kubernetes-01
    needs:
      - metallb/metallb
    installed: true

  ###########################################################
  ## APPLICATIONS
  ###########################################################
  - name: cloudflared
    namespace: cloudflared
    chart: bjw-s/app-template
    version: 4.1.2
    values:
      - ../applications/cloudflared/values.yaml
    installed: true

  - name: blocky
    namespace: blocky
    createNamespace: true
    chart: ../applications/blocky/kubernetes-01
    installed: true

  - name: homer
    namespace: homer
    chart: bjw-s/app-template
    version: 4.1.2
    values:
      - ../applications/homer/values.yaml
    installed: true

  - name: home-assistant
    namespace: home-assistant
    chart: ../applications/home-assistant/kubernetes-01
    needs:
      - cert-manager/cert-manager-extra
      - ingress-nginx/ingress-nginx
    installed: true

  - name: mongodb
    namespace: mongodb
    createNamespace: true
    chart: ../applications/mongodb
    values:
      - ../applications/mongodb/values-kubernetes-01.yaml
    needs:
      - external-secrets/external-secrets-extra
      - csi-driver-nfs/csi-driver-nfs-extra
    installed: true

  - name: nats
    namespace: nats
    createNamespace: true
    chart: ../applications/nats
    values:
      - ../applications/nats/values-kubernetes-01.yaml
    needs:
      - external-secrets/external-secrets-extra
      - csi-driver-nfs/csi-driver-nfs-extra
    installed: true

  - name: omada-controller
    namespace: omada-controller
    chart: ../applications/omada-controller/kubernetes-01
    needs:
      - cert-manager/cert-manager-extra
      - ingress-nginx/ingress-nginx
      - external-secrets/external-secrets-extra
      - csi-driver-nfs/csi-driver-nfs-extra
    installed: true

  - name: vaultwarden
    namespace: vaultwarden
    createNamespace: true
    chart: ../applications/vaultwarden/kubernetes-01
    needs:
      - cert-manager/cert-manager-extra
      - ingress-nginx/ingress-nginx
      - csi-driver-nfs/csi-driver-nfs-extra
    installed: true

  - name: wireguard
    namespace: wireguard
    chart: ../applications/wireguard/kubernetes-01
    needs:
      - csi-driver-nfs/csi-driver-nfs-extra
    installed: true

  - name: congatudo
    namespace: congatudo
    createNamespace: true
    chart: ../applications/congatudo/kubernetes-01
    needs:
      - cert-manager/cert-manager-extra
      - ingress-nginx/ingress-nginx
    installed: true

  - name: hass-mcp
    namespace: hass-mcp
    chart: bjw-s/app-template
    version: 4.1.2
    values:
      - ../applications/hass-mcp/values.yaml
    installed: true

  - name: cloudnative-pg
    namespace: cloudnative-pg
    chart: cloudnative-pg/cloudnative-pg
    version: 0.26.0
    values:
      - ../applications/cloudnative-pg/operator/values.yaml
    installed: true

  ###########################################################
  ## KEYCLOAK COMPONENTS
  ###########################################################
  - name: keycloak-postgres-extra
    namespace: keycloak
    chart: bjw-s/app-template
    version: 4.1.2
    values:
      - ../applications/keycloak/postgres-extra.yaml
    installed: true

  - name: keycloak-postgres
    namespace: keycloak
    chart: cloudnative-pg/cluster
    version: 0.3.1
    values:
      - ../applications/keycloak/postgres.yaml
    installed: true

  - name: keycloak
    namespace: keycloak
    chart: bjw-s/app-template
    version: 4.1.2
    values:
      - ../applications/keycloak/keycloak.yaml
    installed: true
