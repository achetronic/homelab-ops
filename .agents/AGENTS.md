# Agent Instructions for `homelab-ops`

Welcome to the `homelab-ops` repository. This document outlines the structure, tools, and commands you need to know to work effectively in this codebase.

## Overview

This repository is a monorepo for Home Lab Infrastructure and Operations (GitOps/IaC). It is organized primarily around:
1. **Infrastructure as Code (IaC)**: Provisioning VMs, networks, and base OS using Terraform & Terragrunt.
2. **Kubernetes GitOps**: Managing Kubernetes applications, operators, and cluster configs using Helmfile, Helm, and raw Kubernetes manifests.
3. **Task Automation**: Utilizing `go-task` (`task`) to wrap complex multi-step processes into simple commands.

## Code Organization

- `/Taskfile.yaml` & `/.taskfiles/`: Contains all task definitions for building, deploying, and managing tools (Gitlab CLI, Helm, Helmfile, Kubernetes CLI, Terraform, Terragrunt).
- `/infrastructure/terraform/`: Contains Terragrunt and Terraform modules for provisioning infrastructure (e.g., VMs, OPNsense, Talos Linux clusters).
- `/kubernetes/`: Contains all Kubernetes-related configurations.
  - `/kubernetes/helmfile/`: Contains Helmfile definitions (e.g., `kubernetes-01.yaml`) to orchestrate Helm charts.
  - `/kubernetes/applications/`: Contains application-specific manifests, helm values, and Kustomize overlays.
- `/scripts/`: Useful shell scripts for environment preparation.
- `/docs/`: Documentation regarding nodes, networking (OPNsense), and specific Kubernetes distributions (Talos, k0s, k3s).

## Core Tools

- **Task (`go-task`)**: The entrypoint for almost all operations. You should use `task` instead of running `terragrunt` or `helmfile` directly whenever a task wrapper exists.
- **Terragrunt / Terraform**: Used for infrastructure deployment.
- **Helmfile / Helm**: Used for Kubernetes application deployments.
- **Gitlab CLI (`glab`)**: Used for managing tokens and interacting with the Gitlab project.

## Essential Commands

You can list all available tasks by running:
```bash
task -l
```

### Initialization & Setup
- **Install Dependencies**: Downloads and installs the correct versions of all required CLI tools (Terraform, Terragrunt, Helm, Helmfile, Gitlab CLI).
  ```bash
  task global:init
  ```
- **Cleanup**: Removes autogenerated files and temporary tokens.
  ```bash
  task global:cleanup
  ```

### Gitlab Token Management
Many infrastructure tasks require a Gitlab token.
- **Login**: `task gitlab:login`
- **Generate Token**: `task gitlab:generate-supertoken TOKEN_NAME=supertoken`
- **Revoke Token**: `task gitlab:revoke-token TOKEN_NAME=supertoken`

### Infrastructure (Terragrunt)
Apply changes to specific infrastructure scopes:
- **OPNsense**: `task terragrunt:apply-opnsense GITLAB_ACCESS_TOKEN_NAME=supertoken`
- **Virtual Machines**: `task terragrunt:apply-vms GITLAB_ACCESS_TOKEN_NAME=supertoken`
- **Talos Cluster**: `task terragrunt:apply-talos GITLAB_ACCESS_TOKEN_NAME=supertoken`

*(Note: Similar `plan-` and `destroy-` commands exist for each scope).*

### Kubernetes (Helmfile)
To deploy or sync Kubernetes configurations to a specific cluster (e.g., `cluster-01`):
- **Apply All**: `task helmfile:apply-all CLUSTER_NAME=cluster-01`
- **Apply Specific Release**: `task helmfile:apply-one CLUSTER_NAME=cluster-01 RELEASE_NAME=ingress-nginx`
- **Sync All**: `task helmfile:sync-all CLUSTER_NAME=cluster-01`
- **Sync Specific Release**: `task helmfile:sync-one CLUSTER_NAME=cluster-01 RELEASE_NAME=ingress-nginx`

## Important Patterns & Gotchas

1. **Use Tasks First**: Always check `Taskfile.yaml` and `.taskfiles/*.yaml` for an existing task before running raw commands. The tasks handle crucial environment variables, temporary token injection, and precise tool versions.
2. **Cluster Contexts**: For Kubernetes tasks, the `CLUSTER_NAME` variable is heavily used to both select the Helmfile configuration (`kubernetes/helmfile/<cluster_name>.yaml`) and set the `kubectl config use-context`. Ensure your local kubeconfig has the correct context names.
3. **Token Management**: The repository dynamically fetches and uses temporary Gitlab Access Tokens. You must generate a token via the `gitlab:generate-supertoken` task before running Terragrunt tasks.
4. **Temporary Directory**: Tasks heavily rely on a `temp/` folder located at the repository root to store CLI binaries, downloaded packages, and temporary secrets (like `GITLAB_ACCESS_TOKEN`). Do not commit files in this folder.
